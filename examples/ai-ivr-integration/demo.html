<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama + VOICEVOX çµ±åˆãƒ‡ãƒ¢</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #0f3460;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            flex: 1;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .status-ok {
            background: #27ae60;
        }
        .status-error {
            background: #e74c3c;
        }
        .chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 15px;
            margin-bottom: 20px;
            background: #0f0f23;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background: #0f3460;
            text-align: right;
        }
        .ai-message {
            background: #1a472a;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #0f0f23;
            color: #eee;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background: #0f3460;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1a5490;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .speaker-select {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        select {
            padding: 8px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #0f0f23;
            color: #eee;
        }
        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Ollama + ğŸ”Š VOICEVOX çµ±åˆãƒ‡ãƒ¢</h1>

        <div class="status">
            <div class="status-item" id="ollama-status">
                <div>Ollama</div>
                <div id="ollama-status-text">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-item" id="voicevox-status">
                <div>VOICEVOX</div>
                <div id="voicevox-status-text">ç¢ºèªä¸­...</div>
            </div>
        </div>

        <div class="speaker-select">
            <label>è©±è€…:</label>
            <select id="speaker-select">
                <option value="2">å››å›½ã‚ãŸã‚“ï¼ˆãƒãƒ¼ãƒãƒ«ï¼‰</option>
                <option value="0">å››å›½ã‚ãŸã‚“ï¼ˆã‚ã¾ã‚ã¾ï¼‰</option>
                <option value="3">ãšã‚“ã ã‚‚ã‚“ï¼ˆãƒãƒ¼ãƒãƒ«ï¼‰</option>
                <option value="1">ãšã‚“ã ã‚‚ã‚“ï¼ˆã‚ã¾ã‚ã¾ï¼‰</option>
                <option value="8">æ˜¥æ—¥éƒ¨ã¤ã‚€ã</option>
            </select>
        </div>

        <div class="chat-box" id="chat-box"></div>

        <div class="input-group">
            <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
            <button id="send-btn" onclick="sendMessage()">é€ä¿¡</button>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="testVoice()">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>

    <script type="module">
        // Ollama APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        class SimpleOllamaClient {
            constructor(baseUrl = 'http://localhost:11434') {
                this.baseUrl = baseUrl;
            }

            async checkStatus() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/tags`);
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async chat(message) {
                const response = await fetch(`${this.baseUrl}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'phi3.5:latest',
                        prompt: message,
                        stream: false,
                    }),
                });
                const data = await response.json();
                return data.response;
            }
        }

        // VOICEVOX APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        class SimpleVoicevoxClient {
            constructor(baseUrl = 'http://localhost:50021') {
                this.baseUrl = baseUrl;
            }

            async checkStatus() {
                try {
                    const response = await fetch(`${this.baseUrl}/speakers`);
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async speak(text, speakerId = 1) {
                const queryResponse = await fetch(
                    `${this.baseUrl}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`,
                    { method: 'POST' }
                );
                const query = await queryResponse.json();

                const audioResponse = await fetch(
                    `${this.baseUrl}/synthesis?speaker=${speakerId}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(query),
                    }
                );
                return audioResponse.arrayBuffer();
            }

            async playAudio(audioData) {
                const audioContext = new AudioContext();
                const audioBuffer = await audioContext.decodeAudioData(audioData);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);

                return new Promise((resolve) => {
                    source.onended = () => resolve();
                    source.start();
                });
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.ollamaClient = new SimpleOllamaClient();
        window.voicevoxClient = new SimpleVoicevoxClient();

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
        async function checkStatus() {
            const ollamaOk = await window.ollamaClient.checkStatus();
            const voicevoxOk = await window.voicevoxClient.checkStatus();

            document.getElementById('ollama-status').className = ollamaOk ? 'status-item status-ok' : 'status-item status-error';
            document.getElementById('ollama-status-text').textContent = ollamaOk ? 'èµ·å‹•ä¸­' : 'åœæ­¢ä¸­';

            document.getElementById('voicevox-status').className = voicevoxOk ? 'status-item status-ok' : 'status-item status-error';
            document.getElementById('voicevox-status-text').textContent = voicevoxOk ? 'èµ·å‹•ä¸­' : 'åœæ­¢ä¸­';

            return ollamaOk && voicevoxOk;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(text, isUser) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        window.sendMessage = async function() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();

            if (!message) return;

            // UIæ›´æ–°
            addMessage(message, true);
            input.value = '';
            sendBtn.disabled = true;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'è€ƒãˆä¸­...';
            document.getElementById('chat-box').appendChild(loadingDiv);

            try {
                // Ollamaã§å¿œç­”ç”Ÿæˆ
                const aiResponse = await window.ollamaClient.chat(message);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
                loadingDiv.remove();

                // AIå¿œç­”ã‚’è¡¨ç¤º
                addMessage(aiResponse, false);

                // éŸ³å£°åˆæˆã—ã¦å†ç”Ÿ
                const speakerId = parseInt(document.getElementById('speaker-select').value);
                const audioData = await window.voicevoxClient.speak(aiResponse, speakerId);
                await window.voicevoxClient.playAudio(audioData);

            } catch (error) {
                loadingDiv.remove();
                addMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, false);
            } finally {
                sendBtn.disabled = false;
            }
        };

        // éŸ³å£°ãƒ†ã‚¹ãƒˆ
        window.testVoice = async function() {
            const speakerId = parseInt(document.getElementById('speaker-select').value);
            const audioData = await window.voicevoxClient.speak('ãƒ†ã‚¹ãƒˆéŸ³å£°ã§ã™ã€‚ã“ã‚“ã«ã¡ã¯ï¼', speakerId);
            await window.voicevoxClient.playAudio(audioData);
        };

        // Enterã‚­ãƒ¼ã§é€ä¿¡
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // åˆæœŸåŒ–
        checkStatus();
    </script>
</body>
</html>
